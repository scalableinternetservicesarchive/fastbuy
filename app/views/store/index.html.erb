<% if notice %>
<p id="notice"><%= notice %></p>
<% end %>

<h1>FastBuy Catalog</h1>

<% cache ['store', Product.latest] do %>
  <% @products.each do |product| %>
    <% cache ['entry', product] do %>
      <div class="entry">
        <%= image_tag(product.image_url) %>
        <h3><%= product.title %></h3>
        <p><%= sanitize(product.description) %></p>
        <div class="price_line">
          <span class="price">Price: <%= number_to_currency(product.price) %></span>
          <span class="quantity">Quantity: <%= sprintf("%d", product.quantity) %></span>
          <span class="rating">Rating: <%= sprintf("%0.01f", product.rating) %></span>
	  <%= form_tag(line_items_path(product_id: product)) do %>
	    <% if current_product = @cart.line_items.find_by(product_id: product.id) %>
	      <% if product.quantity - current_product.quantity == 0 %>
	        <%= number_field_tag(:quantity, params[:quantity], in: 0..0) %>
	      <% else %>
	        <%= number_field_tag(:quantity, params[:quantity], in: 1..product.quantity \
		    - current_product.quantity \
		    ) %>
	      <% end %>
	    <% else %>
	      <%= number_field_tag(:quantity, params[:quantity], in: 1..product.quantity \
		  ) %>
	    <% end %>
            <%= submit_tag("Submit") %>
	  <% end %>
          <% if product.quantity > 0 %>
            <%= button_to 'Add to Cart', line_items_path(product_id: product), remote: true %>
          <% else %>
            <%= button_to 'Product Unavailable', '.', remote: true, disabled: true %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>

